'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

//Add files to mail
// Select template
window.rcmail&&rcmail.addEventListener('init',function(){rcmail.crm=rcmail.getCrmWindow(),!1==rcmail.crm?jQuery('.yetiforce').hide():(rcmail.env.compose_commands.push('yetiforce.addFilesFromCRM'),rcmail.env.compose_commands.push('yetiforce.selectTemplate'),rcmail.env.compose_commands.push('yetiforce.selectAdress'),rcmail.env.compose_commands.push('yetiforce.selectLabel'),rcmail.env.compose_commands.push('yetiforce.chooseRecord'),rcmail.env.compose_commands.push('yetiforce.refreshTemplate'),rcmail.register_command('yetiforce.addFilesFromCRM',function(){rcmail.addFilesFromCRM();},!0),rcmail.register_command('yetiforce.selectTemplate',function(){rcmail.selectTemplate();},!0),rcmail.register_command('yetiforce.selectAdress',function(module,part){rcmail.selectAdress(module,part);},!0),rcmail.register_command('yetiforce.selectLabel',function(module,part){rcmail.selectLabel(module,part);},!0),rcmail.register_command('yetiforce.chooseRecord',function(module,part){rcmail.chooseRecord(module,part);},!0),rcmail.register_command('yetiforce.refreshTemplate',function(){rcmail.refreshTemplate();},!0),rcmail.env.yf_crmRecordLabel&&($('#baseRecordId').val(rcmail.env.yf_crmRecord),$('#baseRecordModule').val(rcmail.env.yf_crmModule),$('#baseRecordLink').text(rcmail.env.yf_crmRecordLabel),$('#baseRecordLink').attr('title',rcmail.env.yf_crmRecordLabel),$('#baseRecordLink').attr('href',rcmail.crm.CONFIG.siteUrl+'index.php?module='+rcmail.env.yf_crmModule+'&view=Detail&record='+rcmail.env.yf_crmRecord),!$('#baseRecordEmpty').hasClass('d-none')&&$('#baseRecordEmpty').addClass('d-none'),$('#baseRecordLink').removeClass('d-none')));}),rcube_webmail.prototype.addFilesFromCRM=function(){rcmail.crm.app.showRecordsList({module:'Documents',src_module:'Documents',multi_select:!0,additionalInformations:!0,search_params:[[['filelocationtype','e','I']]]},function(modal,instance){instance.setSelectEvent(function(responseData){rcmail.addFilesToMail({ids:Object.keys(responseData)});});});},rcube_webmail.prototype.addFilesToMail=function(data){data._id=rcmail.env.compose_id,data._uploadid=new Date().getTime(),this.http_post('plugin.yetiforce-addFilesToMail',data,this.set_busy(!0,'loading'));},rcube_webmail.prototype.selectTemplate=function(){rcmail.crm.app.showRecordsList({module:'EmailTemplates',src_module:'EmailTemplates'},function(modal,instance){instance.setSelectEvent(function(responseData){var recordId=$('#baseRecordId').val()||rcmail.env.yf_crmRecord,module=$('#baseRecordModule').val()||rcmail.env.yf_crmModule,view=rcmail.env.yf_crmView;if('List'==view){var chElement=jQuery(crm.document).find('.listViewEntriesCheckBox')[0];recordId=jQuery(chElement).val();}jQuery.ajax({type:'Get',url:'?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id='+rcmail.env.compose_id,data:{id:responseData.id,record_id:recordId,select_module:module},dataType:'json',success:function success(data){$('#currentTemplate').val(responseData.id);var html=jQuery('<div/>').html(data.content).html(),ed='';jQuery('[name="_subject"]').val(data.subject),window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))?tinymce.activeEditor.setContent(html):jQuery('#composebody').val(html),jQuery('[name="_to"]').val(data.to),jQuery('[name="_to"]').change(),jQuery('[name="_cc"]').val(data.cc),jQuery('[name="_cc"]').change(),$('[href="#delete"]').each(function(){$(this).trigger('click');}),'undefined'!=typeof data.attachments&&null!==data.attachments&&rcmail.addFilesToMail(data.attachments);}});});});},rcube_webmail.prototype.selectAdress=function(module,part){rcmail.crm.app.showRecordsList({module:module,src_module:'OSSMail',multi_select:!0,additionalInformations:!1},function(modal,instance){instance.setSelectEvent(function(responseData,e){rcmail.getEmailAddresses(responseData,e,module).done(function(emails){if(emails.length){var paetElement=$('#'+part),value=paetElement.val();''!=value&&','!=value.charAt(value.length-1)&&(value+=','),paetElement.val(value+emails.join(',')),paetElement.change();}else rcmail.crm.app.showNotify({text:rcmail.crm.app.vtranslate('NoFindEmailInRecord'),animation:'show'});});});});},rcube_webmail.prototype.getEmailAddresses=function(responseData,e,module){var aDeferred=$.Deferred(),emails=[],label='',email='';return 'undefined'!=typeof e.target&&('email'===$(e.target).data('type')||'multiEmail'===$(e.target).data('type'))?(emails.push($(e.target).text()),aDeferred.resolve(emails)):function(){var i=0,_loop=function(id){rcmail.crm.app.getRecordDetails({record:id,module:module,fieldType:['email','multiEmail']}).done(function(data){i++,label=email=rcmail.getFirstEmailAddress(data.result.data),responseData[id]&&(label=responseData[id]),emails.push(label+'<'+email+'>'),i===Object.keys(responseData).length&&aDeferred.resolve(emails);});};for(var id in responseData)_loop(id);}(),aDeferred.promise()},rcube_webmail.prototype.getFirstEmailAddress=function(data){var emails=[];for(var key in data)if(data[key])if(rcmail.crm.app.isJsonString(data[key])){var multiEmail=JSON.parse(data[key]);for(var i in multiEmail)emails.push(multiEmail[i].e);break}else {emails.push(data[key]);break}return emails},rcube_webmail.prototype.selectLabel=function(module,part){rcmail.crm.app.showRecordsList({module:module,src_module:'OSSMail',multi_select:!0,additionalInformations:!1},function(modal,instance){instance.setSelectEvent(function(responseData){var labels=[];for(var id in responseData)labels.push('['+responseData[id]+']');var ed;if('composebody'===part&&window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody)))ed.execCommand('mceInsertContent',!1,labels.join(', '));else {var partElement=$('#'+part),caretPos=partElement.get(0).selectionStart,caretEnd=partElement.get(0).selectionEnd,oldText=partElement.val(),txtToAdd=labels.join(', ');partElement.val(oldText.substring(0,caretPos)+txtToAdd+oldText.substring(caretEnd)),partElement.get(0).selectionStart=caretPos+txtToAdd.length,partElement.get(0).selectionEnd=caretPos+txtToAdd.length,partElement.focus(),partElement.change();}});});},rcube_webmail.prototype.chooseRecord=function(module){rcmail.crm.app.showRecordsList({module:module,src_module:'OSSMail',multi_select:!1,additionalInformations:!0},function(modal,instance){instance.setSelectEvent(function(responseData){$('#baseRecordId').val(responseData.id),$('#baseRecordModule').val(module),$('#baseRecordLink').text(responseData.name),$('#baseRecordLink').attr('title',responseData.name),$('#baseRecordLink').attr('href',rcmail.crm.CONFIG.siteUrl+'index.php?module='+module+'&view=Detail&record='+responseData.id),$('#baseRecordEmpty').hasClass('d-none')||$('#baseRecordEmpty').addClass('d-none'),$('#baseRecordLink').removeClass('d-none');var templateId=$('#currentTemplate').val();0<templateId&&jQuery.ajax({type:'Get',url:'?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id='+rcmail.env.compose_id,data:{id:templateId,record_id:responseData.id,select_module:module},dataType:'json',success:function success(data){var html=jQuery('<div/>').html(data.content).html(),ed='';jQuery('[name="_subject"]').val(data.subject),window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))?tinymce.activeEditor.setContent(html):jQuery('#composebody').val(html),jQuery('[name="_to"]').val(data.to),jQuery('[name="_to"]').change(),jQuery('[name="_cc"]').val(data.cc),jQuery('[name="_cc"]').change(),$('[href="#delete"]').each(function(){$(this).trigger('click');}),'undefined'!=typeof data.attachments&&null!==data.attachments&&rcmail.addFilesToMail(data.attachments);}});});});},rcube_webmail.prototype.refreshTemplate=function(){var templateId=$('#currentTemplate').val(),recordId=$('#baseRecordId').val(),module=$('#baseRecordModule').val();0<templateId&&0<recordId&&!!module&&jQuery.ajax({type:'Get',url:'?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id='+rcmail.env.compose_id,data:{id:templateId,record_id:recordId,select_module:module},dataType:'json',success:function success(data){var html=jQuery('<div/>').html(data.content).html(),ed='';jQuery('[name="_subject"]').val(data.subject),window.tinyMCE&&(ed=tinyMCE.get(rcmail.env.composebody))?tinymce.activeEditor.setContent(html):jQuery('#composebody').val(html),jQuery('[name="_to"]').val(data.to),jQuery('[name="_to"]').change(),jQuery('[name="_cc"]').val(data.cc),jQuery('[name="_cc"]').change(),$('[href="#delete"]').each(function(){$(this).trigger('click');}),'undefined'!=typeof data.attachments&&null!==data.attachments&&rcmail.addFilesToMail(data.attachments);}});},rcube_webmail.prototype.getCrmWindow=function(){if(null!==opener&&'object'==_typeof(opener.parent.CONFIG))return opener.parent;return null!==parent&&'object'==_typeof(parent.CONFIG)?parent:null!==parent&&null!==parent.opener&&'object'==_typeof(parent.opener.CONFIG)?parent.opener:null!==parent&&null!==parent.parent&&'object'==_typeof(parent.parent.CONFIG)?parent.parent:!(null===opener||null===opener.crm||'object'!=_typeof(opener.crm)||'object'!=_typeof(opener.crm.CONFIG))&&opener.crm};
//# sourceMappingURL=compose.min.js.map
